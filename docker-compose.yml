services:
  test_py314:
    build:
      context: .
      target: py314
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py314.xml && python3 -m coverage report && cp /tmp/coverage_py314.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py313:
    build:
      context: .
      target: py313
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py313.xml && python3 -m coverage report && cp /tmp/coverage_py313.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py312:
    build:
      context: .
      target: py312
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py312.xml && python3 -m coverage report && cp /tmp/coverage_py312.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py311:
    build:
      context: .
      target: py311
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py311.xml && python3 -m coverage report && cp /tmp/coverage_py311.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py310:
    build:
      context: .
      target: py310
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py310.xml && python3 -m coverage report && cp /tmp/coverage_py310.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py39:
    build:
      context: .
      target: py39
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py39.xml && python3 -m coverage report && cp /tmp/coverage_py39.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py38:
    build:
      context: .
      target: py38
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py38.xml && python3 -m coverage report && cp /tmp/coverage_py38.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  test_py37:
    build:
      context: .
      target: py37
    command: bash -c "PYTHONPATH=/app COVERAGE_PROCESS_START=/app/.coveragerc python3 -m coverage run -m pytest tests/ -v -p no:cacheprovider && python3 -m coverage combine && python3 -m coverage xml -o /tmp/coverage_py37.xml && python3 -m coverage report && cp /tmp/coverage_py37.xml . 2>/dev/null || true"
    volumes:
      - .:/app

  # Run all Python versions in sequence
  test_all:
    image: docker:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
    working_dir: /workspace
    command: sh -c "
      echo '=== Testing Python 3.7 ===' &&
      docker-compose run --rm test_py37 &&
      echo '=== Testing Python 3.8 ===' &&
      docker-compose run --rm test_py38 &&
      echo '=== Testing Python 3.9 ===' &&
      docker-compose run --rm test_py39 &&
      echo '=== Testing Python 3.10 ===' &&
      docker-compose run --rm test_py310 &&
      echo '=== Testing Python 3.11 ===' &&
      docker-compose run --rm test_py311 &&
      echo '=== Testing Python 3.12 ===' &&
      docker-compose run --rm test_py312 &&
      echo '=== Testing Python 3.13 ===' &&
      docker-compose run --rm test_py313 &&
      echo '=== Testing Python 3.14 ===' &&
      docker-compose run --rm test_py314 &&
      echo '=== All tests completed ==='
      "

  # Additional service for manual testing and development
  dev:
    build:
      context: .
      target: py314
    command: bash
    volumes:
      - .:/app
    stdin_open: true
    tty: true

